<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

    <body layout:fragment="body">
<body>
  <div class="container py-4">

    <!-- Encabezado -->
    <div class="hero mb-4 d-flex align-items-center justify-content-between gap-3">
      <div>
        <h1 class="h4 mb-1"><i class="bi bi-file-arrow-up me-2"></i>Carga masiva de usuarios</h1>
        <p class="mb-0 opacity-75">Sube un archivo Excel o TXT con el formato esperado para registrar alumnos en lote.</p>
      </div>
    </div>

    <!-- Card principal -->
    <div class="card">
      <div class="card-body">
        <!-- Paso 1: Mostrar Formulario -->
        <div class="text-center">
          <button id="mostrarFormulario" class="btn btn-gradient btn-lg">
            <i class="bi bi-plus-circle me-1"></i> Mostrar formulario
          </button>
        </div>

        <!-- Paso 2: Botones de tipo de archivo -->
        <div id="botones" class="row justify-content-center mt-4" style="display:none;">
          <div class="col-md-8">
            <div class="d-grid d-md-flex gap-2 justify-content-center">
              <button class="btn btn-success px-4" id="btnExcel">
                <i class="bi bi-file-earmark-excel me-1"></i> Excel (.xlsx)
              </button>
              <button class="btn btn-primary px-4" id="btnTxt">
                <i class="bi bi-filetype-txt me-1"></i> TXT (.txt)
              </button>
            </div>
            <p class="text-center mt-2 hint">Primero elige el tipo de archivo que subirás.</p>
          </div>
        </div>

        <!-- Paso 3: Formulario de carga -->
        <div id="formularioArchivo" class="row justify-content-center mt-3" style="display:none;">
          <div class="col-lg-8">
            <!-- De acuerdo a tu proyecto: /usuario/cargamasiva -->
            <form th:action="@{/usuario/cargamasiva}" action="/usuario/cargamasiva" method="post" enctype="multipart/form-data" id="formCarga">
              <div id="dropZone" class="drop-zone mb-3">
                <div class="mb-2"><i class="bi bi-cloud-arrow-up display-6"></i></div>
                <p class="mb-1">Arrastra y suelta tu archivo aquí</p>
                <p class="hint mb-2">o</p>
                <label class="btn btn-outline-secondary">
                  <i class="bi bi-folder2-open me-1"></i> Elegir archivo
                  <input type="file" id="archivo" name="archivo" class="d-none" accept=".xlsx,.txt">
                </label>
                <div id="fileInfo" class="mt-2 small text-muted">Ningún archivo seleccionado</div>
              </div>

              <!-- Alertas -->
              <div id="alertaTipo" class="alert alert-warning py-2 d-none" role="alert">
                <i class="bi bi-exclamation-triangle me-1"></i> Debes seleccionar el tipo de archivo (Excel o TXT) antes de elegir el archivo.
              </div>
              <div id="alertaExtension" class="alert alert-danger py-2 d-none" role="alert">
                <i class="bi bi-x-circle me-1"></i> El archivo seleccionado no coincide con el tipo esperado.
              </div>

              <!-- Reglas rápidas / ayuda -->
              <div class="border rounded p-3 bg-light mb-3">
                <div class="fw-semibold mb-2"><i class="bi bi-info-circle me-1"></i> Requisitos del archivo</div>
                <ul class="mb-0 small">
                  <li>Para <span class="fw-semibold">Excel</span>: extensión <code>.xlsx</code>.</li>
                  <li>Para <span class="fw-semibold">TXT</span>: extensión <code>.txt</code>, campos separados según tu especificación.</li>
                  <li>Asegúrate de respetar el orden y los encabezados requeridos.</li>
                </ul>
              </div>

              <!-- Acciones -->
              <div class="d-grid d-sm-flex gap-2 justify-content-end">
                <button type="submit" class="btn btn-success" id="cargaMasiva" disabled>
                  <i class="bi bi-upload me-1"></i> Subir archivo
                </button>
                <button type="button" class="btn btn-outline-secondary" id="btnLimpiar">
                  <i class="bi bi-eraser me-1"></i> Limpiar
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- ===== Resultado de validación (tu bloque) ===== -->
        <div class="mt-4" th:if="${archivoCorrecto!= null}">
          <div th:if="${listaErrores.isEmpty()}">
            <h4>Archivo correcto: </h4>
            <!-- Ruta corregida a USUARIO -->
            <a th:href="@{/usuario/cargamasiva/procesar}" class="btn btn-success">Procesar archivo</a>
          </div>
          <div th:unless="${listaErrores.isEmpty()}">
            <h4>Archivo incorrecto: </h4>
            <table class="table table-responsive table-bordered">
              <thead class="table-dark">
                <tr><th class="col-2">Linea</th><th>Texto</th><th>Error</th></tr>
              </thead>
              <tbody>
                <tr th:each="error :${listaErrores}">
                  <td th:text="${error.linea}"></td>
                  <td th:text="${error.dato}"></td>
                  <td th:text="${error.mensaje}"></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <!-- ===== Fin resultado ===== -->

      </div>
    </div>

  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    let tipoArchivo = ""; // "xlsx" | "txt"
    const $mostrarFormulario = document.getElementById("mostrarFormulario");
    const $botones = document.getElementById("botones");
    const $formularioArchivo = document.getElementById("formularioArchivo");
    const $btnExcel = document.getElementById("btnExcel");
    const $btnTxt = document.getElementById("btnTxt");
    const $archivo = document.getElementById("archivo");
    const $cargaMasiva = document.getElementById("cargaMasiva");
    const $fileInfo = document.getElementById("fileInfo");
    const $alertaTipo = document.getElementById("alertaTipo");
    const $alertaExtension = document.getElementById("alertaExtension");
    const $btnLimpiar = document.getElementById("btnLimpiar");
    const $dropZone = document.getElementById("dropZone");
    const $form = document.getElementById("formCarga");

    $mostrarFormulario.addEventListener("click", () => {
      $mostrarFormulario.classList.add("d-none");
      $botones.style.display = "block";
    });

    $btnExcel.addEventListener("click", () => {
      tipoArchivo = "xlsx";
      $formularioArchivo.style.display = "block";
      $archivo.setAttribute("accept", ".xlsx");
      $cargaMasiva.classList.remove("btn-primary");
      $cargaMasiva.classList.add("btn-success");
      ocultarAlertas(); resetFile();
    });

    $btnTxt.addEventListener("click", () => {
      tipoArchivo = "txt";
      $formularioArchivo.style.display = "block";
      $archivo.setAttribute("accept", ".txt");
      $cargaMasiva.classList.remove("btn-success");
      $cargaMasiva.classList.add("btn-primary");
      ocultarAlertas(); resetFile();
    });

    $archivo.addEventListener("change", function(){ if (!validarAntesDeElegir()) return; manejarArchivo(this.files[0]); });

    ["dragenter","dragover"].forEach(evt =>
      $dropZone.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); $dropZone.classList.add("dragover"); })
    );
    ["dragleave","drop"].forEach(evt =>
      $dropZone.addEventListener(evt, e => {
        e.preventDefault(); e.stopPropagation();
        if (evt === "drop") { if (!validarAntesDeElegir()) return; const file = e.dataTransfer.files?.[0]; if (file) manejarArchivo(file); }
        $dropZone.classList.remove("dragover");
      })
    );

    $form.addEventListener("submit", (e) => {
      if (!$archivo.files.length || !tipoArchivo) { e.preventDefault(); mostrarAlertaTipo(); }
    });

    $btnLimpiar.addEventListener("click", resetTodo);

    function validarAntesDeElegir(){ if (!tipoArchivo){ mostrarAlertaTipo(); return false; } ocultarAlertas(); return true; }
    function manejarArchivo(file){
      if (!file) return;
      const extension = file.name.split(".").pop().toLowerCase();
      if (extension !== tipoArchivo){ mostrarAlertaExtension(); resetFile(); return; }
      $fileInfo.innerHTML = `<span class="file-name">${file.name}</span> &middot; ${(file.size/1024).toFixed(1)} KB`;
      $cargaMasiva.disabled = false;
      const dt = new DataTransfer(); dt.items.add(file); $archivo.files = dt.files;
    }
    function mostrarAlertaTipo(){ $alertaExtension.classList.add("d-none"); $alertaTipo.classList.remove("d-none"); $cargaMasiva.disabled = true; }
    function mostrarAlertaExtension(){ $alertaTipo.classList.add("d-none"); $alertaExtension.classList.remove("d-none"); $cargaMasiva.disabled = true; }
    function ocultarAlertas(){ $alertaTipo.classList.add("d-none"); $alertaExtension.classList.add("d-none"); }
    function resetFile(){ $archivo.value = ""; $fileInfo.textContent = "Ningún archivo seleccionado"; $cargaMasiva.disabled = true; }
    function resetTodo(){ tipoArchivo = ""; $mostrarFormulario.classList.remove("d-none"); $botones.style.display = "none"; $formularioArchivo.style.display = "none"; ocultarAlertas(); resetFile(); }
  </script>
</body>
</html>
